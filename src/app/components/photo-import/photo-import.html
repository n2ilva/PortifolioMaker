<div class="photo-import-overlay" *ngIf="isVisible" (click)="closeModal()">
  <div class="photo-import-modal" [class.expanded]="showGooglePhotos" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2><span class="material-icons">auto_awesome</span> Importar Inteligente</h2>
      <button class="close-btn" (click)="closeModal()"><span class="material-icons">close</span></button>
    </div>

    <div class="modal-body">
      <!-- Instru√ß√µes -->
      <div class="instructions">
        <h4><span class="material-icons">checklist</span> Como usar:</h4>
        <ol>
          <li>Selecione suas fotos do computador ou do Google Fotos</li>
          <li>Configure em qual slide cada foto deve entrar</li>
          <li>Slides que n√£o existem ser√£o criados automaticamente</li>
        </ol>
        <div class="info-box">
          <span class="info-icon material-icons">info</span>
          <span>Voc√™ tem <strong>{{ getSlidesCount() }}</strong> slide(s) existente(s).</span>
        </div>
      </div>

      <!-- √Årea de Sele√ß√£o de Fonte -->
      <div class="source-buttons">
        <div 
          class="drop-zone"
          [class.drag-over]="isDragOver"
          [class.compact]="photos.length > 0"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
        >
          <div class="drop-content">
            <span class="drop-icon material-icons">add_photo_alternate</span>
            <p>Arraste suas fotos aqui</p>
            <span class="drop-or">ou</span>
            <button class="select-btn" (click)="onSelectFiles()">Selecionar Arquivos</button>
          </div>
        </div>

        <div class="google-photos-btn-container">
          <button class="google-photos-toggle" (click)="toggleGooglePhotos()">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="#EA4335" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
              <path fill="#fff" d="M12 7a5 5 0 100 10 5 5 0 000-10z"/>
            </svg>
            <span>{{ showGooglePhotos ? 'Fechar Google Fotos' : 'Importar do Google Fotos' }}</span>
          </button>
        </div>
      </div>

      <!-- Google Photos Panel -->
      @if (showGooglePhotos) {
        <div class="google-photos-panel">
          @if (!googlePhotos.isAuthenticated()) {
            <div class="google-login-section">
              <p>Conecte-se para acessar suas fotos do Google</p>
              <button class="btn-google-login" (click)="onGoogleLogin()">
                <svg viewBox="0 0 24 24" width="18" height="18">
                  <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Entrar com Google
              </button>
            </div>
          } @else {
            <!-- User Info -->
            <div class="google-user-bar">
              @if (googlePhotos.userInfo(); as user) {
                <img [src]="user.picture" [alt]="user.name" [title]="user.name" class="user-avatar">
                <span class="user-name">{{ user.name }}</span>
              }
              <button class="btn-logout" (click)="onGoogleLogout()">Sair</button>
            </div>

            <!-- Navigation -->
            <div class="google-nav">
              @if (googleView !== 'albums') {
                <button class="btn-back" (click)="onBackToAlbums()">‚Üê √Ålbuns</button>
              }
              @if (googleView === 'albums') {
                <button class="btn-all-photos" (click)="onShowAllGooglePhotos()"><span class="material-icons">photo_library</span> Todas as Fotos</button>
              }
              @if (selectedAlbum) {
                <span class="current-album"><span class="material-icons">folder</span> {{ selectedAlbum.title }}</span>
              }
            </div>

            <!-- Loading -->
            @if (googlePhotos.isLoading()) {
              <div class="google-loading">
                <div class="spinner"></div>
                <span>Carregando...</span>
              </div>
            }

            <!-- Error Message -->
            @if (googlePhotos.error()) {
              <div class="google-error">
                <span class="error-icon material-icons">warning</span>
                <p>{{ googlePhotos.error() }}</p>
                @if (googlePhotos.error()?.includes('API')) {
                  <a href="https://console.cloud.google.com/apis/library/drive.googleapis.com" target="_blank" rel="noopener" class="error-link">
                    Abrir Google Cloud Console
                  </a>
                }
              </div>
            }

            <!-- Albums -->
            @if (googleView === 'albums' && !googlePhotos.isLoading()) {
              <div class="google-albums-grid">
                @for (album of googlePhotos.albums(); track album.id) {
                  <div class="album-card" (click)="onSelectAlbum(album)">
                    @if (album.coverPhotoBaseUrl) {
                      <img [src]="album.coverPhotoBaseUrl + '=w150-h150-c'" [alt]="album.title" [title]="album.title">
                    } @else {
                      <div class="no-cover"><span class="material-icons">folder</span></div>
                    }
                    <span class="album-title">{{ album.title }}</span>
                  </div>
                }
                @if (googlePhotos.albums().length === 0) {
                  <div class="no-albums-message">
                    <p class="no-albums">Nenhum √°lbum encontrado</p>
                    <p class="no-albums-hint">A API do Google Photos s√≥ mostra √°lbuns criados manualmente.</p>
                    <p class="no-albums-hint">Use o bot√£o <strong>"Todas as Fotos"</strong> acima para ver suas fotos.</p>
                  </div>
                }
              </div>
            }

            <!-- Photos -->
            @if ((googleView === 'photos' || googleView === 'all-photos') && !googlePhotos.isLoading()) {
              <div class="google-selection-bar">
                <span>{{ getGoogleSelectedCount() }} selecionada(s)</span>
                <button (click)="selectAllGooglePhotos()">Selecionar Todas</button>
                <button (click)="deselectAllGooglePhotos()">Limpar</button>
              </div>
              
              <div class="google-photos-grid">
                @for (photo of googlePhotos.photos(); track photo.id) {
                  <div 
                    class="google-photo-card" 
                    [class.selected]="photo.selected"
                    (click)="onToggleGooglePhoto(photo)"
                  >
                    <img [src]="photo.baseUrl + '=w120-h120-c'" [alt]="photo.filename">
                    @if (photo.selected) {
                      <div class="photo-check"><span class="material-icons">check</span></div>
                    }
                  </div>
                }
              </div>

              @if (getGoogleSelectedCount() > 0) {
                <button class="btn-add-google-photos" (click)="addGooglePhotosToImport()">
                  Adicionar {{ getGoogleSelectedCount() }} Foto(s) √† Importa√ß√£o
                </button>
              }
            }
          }
        </div>
      }

      <input 
        #folderInput
        type="file" 
        multiple 
        accept="image/*"
        (change)="onFilesSelected($event)"
        class="hidden-input"
        title="Selecionar fotos"
      >

      <!-- Mensagens -->
      @if (errorMessage) {
        <div class="message error">
          <span class="message-icon material-icons">error</span>
          {{ errorMessage }}
        </div>
      }

      @if (successMessage) {
        <div class="message success">
          <span class="message-icon material-icons">check_circle</span>
          {{ successMessage }}
        </div>
      }

      <!-- Configura√ß√£o por Slide -->
      @if (photos.length > 0) {
        <div class="slides-config-section">
          <h4><span class="material-icons">bar_chart</span> Distribui√ß√£o das Fotos por Slide ({{ photos.length }} foto(s))</h4>
          
          @for (config of getSlidesWithPhotos(); track config.slideNumber) {
            <div class="slide-config-card" [class.new-slide]="!config.exists">
              <div class="slide-config-header">
                <div class="slide-title">
                  <span class="slide-badge" [class.new]="!config.exists">
                    {{ config.exists ? 'Slide ' + config.slideNumber : '+ Novo Slide ' + config.slideNumber }}
                  </span>
                  <span class="slot-info">{{ config.photos.length }}/{{ config.imageSlots }} fotos</span>
                </div>
                
                <div class="header-controls">
                  <!-- Campo de nome para novos slides -->
                  @if (!config.exists) {
                    <div class="slide-name-field">
                      <label>Nome:</label>
                      <input 
                        type="text" 
                        [value]="config.slideName"
                        (input)="onSlideNameChange(config, $event)"
                        placeholder="Digite o nome do slide"
                        class="slide-name-input"
                        title="Nome do novo slide"
                      >
                    </div>
                  }
                  
                  <div class="layout-selector">
                    <label>Layout:</label>
                    <select 
                      [value]="config.layoutId"
                      (change)="onSlideLayoutChange(config, $event)"
                      title="Selecionar layout do slide"
                    >
                      @for (layout of layouts; track layout.id) {
                        <option [value]="layout.id">{{ layout.name }}</option>
                      }
                    </select>
                  </div>
                </div>
              </div>

              <div class="photos-in-slide">
                @for (photo of config.photos; track photo.orderNumber) {
                  <div class="photo-config-item">
                    <img [src]="photo.dataUrl" [alt]="photo.name" [title]="photo.name" class="photo-thumb">
                    
                    <div class="photo-details">
                      <div class="photo-name-row">
                        <span class="photo-filename" [title]="photo.name">{{ photo.name }}</span>
                        <button class="remove-photo-btn" (click)="removePhoto(photo)" title="Remover foto"><span class="material-icons">close</span></button>
                      </div>
                      
                      <div class="photo-controls">
                        <div class="control-group">
                          <label>Sequ√™ncia:</label>
                          <input 
                            type="number" 
                            [value]="photo.orderNumber"
                            (change)="onPhotoOrderChange(photo, $event)"
                            min="1"
                            class="order-input"
                            title="N√∫mero de sequ√™ncia da foto"
                          >
                        </div>
                        
                        <div class="control-group">
                          <label>Slide:</label>
                          <select 
                            [value]="photo.targetSlide"
                            (change)="onPhotoSlideChange(photo, $event)"
                            title="Slide de destino"
                          >
                            @for (slideNum of getSlideOptions(); track slideNum) {
                              <option [value]="slideNum">
                                {{ slideNum <= getSlidesCount() ? 'Slide ' + slideNum : '+ Novo ' + slideNum }}
                              </option>
                            }
                          </select>
                        </div>
                        
                        <div class="control-group">
                          <label>Posi√ß√£o:</label>
                          <select 
                            [value]="photo.slotInSlide"
                            (change)="onPhotoSlotChange(photo, $event)"
                            title="Posi√ß√£o no slide"
                          >
                            @for (slot of getSlotOptions(photo.targetSlide); track slot) {
                              <option [value]="slot">{{ slot }}¬™ foto</option>
                            }
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>

        <!-- Resumo -->
        <div class="import-summary">
          <span>üìå Total: <strong>{{ photos.length }}</strong> foto(s) para <strong>{{ getSlidesWithPhotos().length }}</strong> slide(s)</span>
          @if (getSlidesWithPhotos().length > getSlidesCount()) {
            <span class="new-slides-info">
              ({{ getSlidesWithPhotos().length - getSlidesCount() }} novo(s) slide(s) ser√°(√£o) criado(s))
            </span>
          }
        </div>
      }

      <!-- Loading -->
      @if (isProcessing) {
        <div class="loading">
          <div class="spinner"></div>
          @if (downloadProgress.total > 0) {
            <span>Baixando fotos... {{ downloadProgress.completed }}/{{ downloadProgress.total }}</span>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="(downloadProgress.completed / downloadProgress.total) * 100"></div>
            </div>
          } @else {
            <span>Processando...</span>
          }
        </div>
      }
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeModal()">Cancelar</button>
      <button 
        class="btn-import" 
        (click)="importPhotos()"
        [disabled]="photos.length === 0 || isProcessing"
      >
        Importar {{ photos.length }} Foto(s)
      </button>
    </div>
  </div>
</div>
