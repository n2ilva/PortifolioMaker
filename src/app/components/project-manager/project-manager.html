<div class="project-manager-overlay" (click)="closeModal()">
  <div class="project-manager-modal" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <h2><span class="material-icons-round">folder_open</span> Meus Projetos</h2>
      <button class="close-btn" (click)="closeModal()">
        <span class="material-icons-round">close</span>
      </button>
    </div>
    
    <!-- Login Banner (quando não autenticado) -->
    @if (!googleService.isAuthenticated()) {
      <div class="login-banner">
        <div class="login-banner-content">
          <div class="login-banner-text">
            <span class="material-icons-round login-banner-icon">cloud</span>
            <div>
              <strong>Sincronize seus projetos</strong>
              <p>Faça login com Google para salvar no Drive e acessar de qualquer lugar</p>
            </div>
          </div>
          <button class="google-login-btn-small" (click)="googleService.login()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
            Entrar com Google
          </button>
        </div>
      </div>
    } @else {
      <!-- Usuário logado -->
      <div class="user-banner">
        <div class="user-info-row">
          @if (googleService.userInfo()?.picture) {
            <img [src]="googleService.userInfo()?.picture" alt="Avatar" class="user-avatar">
          }
          <div class="user-details">
            <strong>{{ googleService.userInfo()?.name }}</strong>
            <span>{{ googleService.userInfo()?.email }}</span>
          </div>
          <button class="logout-btn" (click)="googleService.logout()" title="Sair">
            <span class="material-icons-round">logout</span> Sair
          </button>
        </div>
      </div>
    }
    
    <!-- Ações principais -->
    <div class="modal-actions">
      <button class="action-btn primary" (click)="openSaveDialog()">
        <span class="material-icons-round">save</span> Salvar Projeto Atual
      </button>
      <button class="action-btn" (click)="newProject()">
        <span class="material-icons-round">add</span> Novo Projeto
      </button>
      <label class="action-btn">
        <span class="material-icons-round">file_upload</span> Importar
        <input type="file" accept=".json,.pmk" (change)="importProject($event)" hidden>
      </label>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
      <button 
        class="tab" 
        [class.active]="activeTab() === 'local'"
        (click)="switchTab('local')"
      >
        <span class="material-icons-round">computer</span> Armazenamento Local
      </button>
      <button 
        class="tab" 
        [class.active]="activeTab() === 'drive'"
        (click)="switchTab('drive')"
        [disabled]="!googleService.isAuthenticated()"
      >
        <span class="material-icons-round">cloud</span> Google Drive
        @if (!googleService.isAuthenticated()) {
          <span class="tab-badge">Login</span>
        }
      </button>
    </div>
    
    <!-- Conteúdo -->
    <div class="modal-content">
      @if (isLoading()) {
        <div class="loading">
          <div class="spinner"></div>
          <p>Carregando projetos...</p>
        </div>
      } @else {
        <!-- Tab Local -->
        @if (activeTab() === 'local') {
          @if (projectStorage.projects().length === 0) {
            <div class="empty-state">
              <span class="material-icons-round empty-icon">folder_off</span>
              <p>Nenhum projeto salvo localmente</p>
              <span class="empty-hint">Salve seu projeto atual para acessá-lo depois</span>
            </div>
          } @else {
            <div class="projects-grid">
              @for (project of projectStorage.projects(); track project.id) {
                <div class="project-card" (click)="loadLocalProject(project)">
                  <div class="project-thumbnail">
                    @if (project.thumbnail) {
                      <img [src]="project.thumbnail" alt="Miniatura">
                    } @else {
                      <span class="material-icons-round thumbnail-placeholder">image</span>
                    }
                  </div>
                  <div class="project-info">
                    <h3 class="project-name">{{ project.name }}</h3>
                    <span class="project-meta">
                      {{ project.slidesCount }} slide{{ project.slidesCount !== 1 ? 's' : '' }}
                    </span>
                    <span class="project-date">{{ formatDate(project.updatedAt) }}</span>
                  </div>
                  <div class="project-actions" (click)="$event.stopPropagation()">
                    <button class="icon-btn" title="Exportar" (click)="exportProject(project)">
                      <span class="material-icons-round">file_download</span>
                    </button>
                    <button class="icon-btn danger" title="Excluir" (click)="confirmDelete(project.id, project.name, 'local')">
                      <span class="material-icons-round">delete</span>
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        }
        
        <!-- Tab Drive -->
        @if (activeTab() === 'drive') {
          @if (!googleService.isAuthenticated()) {
            <div class="empty-state">
              <span class="material-icons-round empty-icon">cloud_off</span>
              <p>Conecte sua conta Google</p>
              <span class="empty-hint">Faça login para salvar e acessar projetos no Google Drive</span>
              <button class="google-login-btn" (click)="googleService.login()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                Entrar com Google
              </button>
            </div>
          } @else {
            @if (driveProjects().length === 0) {
              <div class="empty-state">
                <span class="material-icons-round empty-icon">cloud_queue</span>
                <p>Nenhum projeto no Google Drive</p>
                <span class="empty-hint">Salve seu projeto atual no Drive para acessá-lo de qualquer lugar</span>
              </div>
            } @else {
              <div class="projects-grid">
                @for (project of driveProjects(); track project.id) {
                  <div class="project-card" (click)="loadDriveProject(project)">
                    <div class="project-thumbnail">
                      <span class="material-icons-round thumbnail-placeholder">cloud</span>
                    </div>
                    <div class="project-info">
                      <h3 class="project-name">{{ project.name }}</h3>
                      <span class="project-meta cloud">Google Drive</span>
                      <span class="project-date">{{ formatDate(project.modifiedTime) }}</span>
                    </div>
                    <div class="project-actions" (click)="$event.stopPropagation()">
                      <button class="icon-btn danger" title="Excluir" (click)="confirmDelete(project.id, project.name, 'drive')">
                        <span class="material-icons-round">delete</span>
                      </button>
                    </div>
                  </div>
                }
              </div>
            }
          }
        }
      }
    </div>
  </div>
</div>

<!-- Diálogo de Salvar -->
@if (showSaveDialog()) {
  <div class="dialog-overlay" (click)="showSaveDialog.set(false)">
    <div class="dialog" (click)="$event.stopPropagation()">
      <h3><span class="material-icons-round">save</span> Salvar Projeto</h3>
      
      <div class="form-group">
        <label>Nome do Projeto</label>
        <input 
          type="text" 
          [(ngModel)]="saveProjectName" 
          placeholder="Digite o nome do projeto"
          autofocus
        >
      </div>
      
      <div class="form-group">
        <label>Salvar em</label>
        <div class="save-options">
          <label class="save-option">
            <input type="radio" name="saveLocation" value="local" [(ngModel)]="saveLocation">
            <span class="material-icons-round option-icon">computer</span>
            <span class="option-text">Local</span>
          </label>
          
          @if (googleService.isAuthenticated()) {
            <label class="save-option">
              <input type="radio" name="saveLocation" value="drive" [(ngModel)]="saveLocation">
              <span class="material-icons-round option-icon">cloud</span>
              <span class="option-text">Google Drive</span>
            </label>
            
            <label class="save-option">
              <input type="radio" name="saveLocation" value="both" [(ngModel)]="saveLocation">
              <span class="material-icons-round option-icon">sync</span>
              <span class="option-text">Ambos</span>
            </label>
          }
        </div>
      </div>
      
      <div class="dialog-actions">
        <button class="btn-cancel" (click)="showSaveDialog.set(false)">Cancelar</button>
        <button 
          class="btn-save" 
          (click)="saveProject()"
          [disabled]="!saveProjectName.trim() || isSaving()"
        >
          @if (isSaving()) {
            <span class="material-icons-round spin">sync</span> Salvando...
          } @else {
            <span class="material-icons-round">save</span> Salvar
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Confirmação de Exclusão -->
@if (showDeleteConfirm()) {
  <div class="dialog-overlay" (click)="showDeleteConfirm.set(false)">
    <div class="dialog danger" (click)="$event.stopPropagation()">
      <h3><span class="material-icons-round">delete</span> Excluir Projeto</h3>
      <p>Tem certeza que deseja excluir <strong>"{{ projectToDelete?.name }}"</strong>?</p>
      <p class="warning">Esta ação não pode ser desfeita.</p>
      
      <div class="dialog-actions">
        <button class="btn-cancel" (click)="showDeleteConfirm.set(false)">Cancelar</button>
        <button class="btn-delete" (click)="deleteProject()">
          <span class="material-icons-round">delete_forever</span> Excluir
        </button>
      </div>
    </div>
  </div>
}

<!-- Diálogo de Alterações Não Salvas -->
@if (showUnsavedChangesDialog()) {
  <div class="dialog-overlay" (click)="cancelPendingAction()">
    <div class="dialog warning" (click)="$event.stopPropagation()">
      <h3><span class="material-icons-round">warning</span> Alterações Não Salvas</h3>
      <p>Você tem alterações não salvas no projeto atual.</p>
      <p>O que deseja fazer?</p>
      
      <div class="dialog-actions-vertical">
        <button class="btn-save-continue" (click)="saveAndContinue()">
          <span class="material-icons-round">save</span> Salvar e Continuar
        </button>
        <button class="btn-discard" (click)="discardAndContinue()">
          <span class="material-icons-round">delete_sweep</span> Descartar Alterações
        </button>
        <button class="btn-cancel" (click)="cancelPendingAction()">
          <span class="material-icons-round">arrow_back</span> Voltar
        </button>
      </div>
    </div>
  </div>
}
