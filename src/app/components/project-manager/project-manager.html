<div class="project-manager-overlay" (click)="closeModal()">
  <div class="project-manager-modal" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <h2><span class="material-icons">folder_open</span> Meus Projetos</h2>
      <button class="close-btn" (click)="closeModal()">
        <span class="material-icons">close</span>
      </button>
    </div>
    
    <!-- Login Banner (quando não autenticado) -->
    @if (!supabase.isAuthenticated()) {
      <div class="login-banner">
        <div class="login-banner-content">
          <div class="login-banner-text">
            <span class="material-icons login-banner-icon">cloud</span>
            <div>
              <strong>Sincronize seus projetos na nuvem</strong>
              <p>Faça login para salvar e acessar seus projetos de qualquer lugar</p>
            </div>
          </div>
          <div class="login-buttons">
            <button class="google-login-btn" (click)="signInWithGoogle()">
              <svg viewBox="0 0 24 24" width="18" height="18">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              Entrar com Google
            </button>
            <button class="email-login-btn" (click)="openAuthDialog('login')">
              <span class="material-icons">email</span>
              Entrar com Email
            </button>
          </div>
        </div>
      </div>
    } @else {
      <!-- Usuário logado -->
      <div class="user-banner">
        <div class="user-info-row">
          @if (getUserInfo()?.picture) {
            <img [src]="getUserInfo()?.picture" alt="Avatar" class="user-avatar">
          } @else {
            <div class="user-avatar-placeholder">
              <span class="material-icons">person</span>
            </div>
          }
          <div class="user-details">
            <strong>{{ getUserInfo()?.name }}</strong>
            <span>{{ getUserInfo()?.email }}</span>
          </div>
          <button class="logout-btn" (click)="signOut()" title="Sair">
            <span class="material-icons">logout</span> Sair
          </button>
        </div>
      </div>
    }
    
    <!-- Ações principais -->
    <div class="modal-actions">
      <button class="action-btn primary" (click)="openSaveDialog()">
        <span class="material-icons">save</span> Salvar Projeto Atual
      </button>
      <button class="action-btn" (click)="newProject()">
        <span class="material-icons">add</span> Novo Projeto
      </button>
      <label class="action-btn">
        <span class="material-icons">file_upload</span> Importar
        <input type="file" accept=".json,.pmk" (change)="importProject($event)" hidden>
      </label>
      <button 
        class="action-btn export-pdf" 
        (click)="exportPdf()" 
        [disabled]="isExportingPdf"
        title="Exportar como PDF"
      >
        @if (isExportingPdf) {
          <span class="material-icons spin">sync</span> Exportando...
        } @else {
          <span class="material-icons">picture_as_pdf</span> Exportar PDF
        }
      </button>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
      <button 
        class="tab" 
        [class.active]="activeTab() === 'cloud'"
        (click)="switchTab('cloud')"
      >
        <span class="material-icons">cloud</span> Nuvem
        @if (!supabase.isAuthenticated()) {
          <span class="tab-badge">Login</span>
        }
      </button>
      <button 
        class="tab" 
        [class.active]="activeTab() === 'local'"
        (click)="switchTab('local')"
      >
        <span class="material-icons">computer</span> Local
      </button>
    </div>
    
    <!-- Conteúdo -->
    <div class="modal-content">
      @if (isLoading()) {
        <div class="loading">
          <div class="spinner"></div>
          <p>Carregando projetos...</p>
        </div>
      } @else {
        <!-- Tab Nuvem -->
        @if (activeTab() === 'cloud') {
          @if (!supabase.isAuthenticated()) {
            <div class="empty-state">
              <span class="material-icons empty-icon">cloud_off</span>
              <p>Faça login para acessar seus projetos na nuvem</p>
              <button class="btn-login-empty" (click)="openAuthDialog('login')">
                <span class="material-icons">login</span> Fazer Login
              </button>
            </div>
          } @else if (cloudProjects().length === 0) {
            <div class="empty-state">
              <span class="material-icons empty-icon">cloud_queue</span>
              <p>Nenhum projeto salvo na nuvem</p>
              <span class="empty-hint">Salve seu projeto atual para acessá-lo de qualquer lugar</span>
            </div>
          } @else {
            <div class="projects-grid">
              @for (project of cloudProjects(); track project.id) {
                <div class="project-card" (click)="loadCloudProject(project)">
                  <div class="project-thumbnail">
                    @if (project.thumbnail) {
                      <img [src]="project.thumbnail" [alt]="project.name">
                    } @else {
                      <span class="material-icons thumbnail-placeholder">image</span>
                    }
                  </div>
                  <div class="project-info">
                    <h4>{{ project.name }}</h4>
                    <span class="project-date">{{ formatDate(project.updated_at) }}</span>
                    <span class="project-slides">{{ project.slides.length }} slides</span>
                  </div>
                  <div class="project-actions">
                    <button class="btn-delete" (click)="confirmDelete(project.id, project.name, 'cloud'); $event.stopPropagation()" title="Excluir">
                      <span class="material-icons">delete</span>
                    </button>
                  </div>
                  <div class="project-badge cloud">
                    <span class="material-icons">cloud</span>
                  </div>
                </div>
              }
            </div>
          }
        }
        
        <!-- Tab Local -->
        @if (activeTab() === 'local') {
          @if (projectStorage.projects().length === 0) {
            <div class="empty-state">
              <span class="material-icons empty-icon">folder_off</span>
              <p>Nenhum projeto salvo localmente</p>
              <span class="empty-hint">Salve seu projeto atual para acessá-lo depois</span>
            </div>
          } @else {
            <div class="projects-grid">
              @for (project of projectStorage.projects(); track project.id) {
                <div class="project-card" (click)="loadLocalProject(project)">
                  <div class="project-thumbnail">
                    @if (project.thumbnail) {
                      <img [src]="project.thumbnail" [alt]="project.name">
                    } @else {
                      <span class="material-icons thumbnail-placeholder">image</span>
                    }
                  </div>
                  <div class="project-info">
                    <h4>{{ project.name }}</h4>
                    <span class="project-date">{{ formatDate(project.updatedAt) }}</span>
                    <span class="project-slides">{{ project.slidesCount }} slides</span>
                  </div>
                  <div class="project-actions">
                    <button class="btn-export" (click)="exportProject(project); $event.stopPropagation()" title="Exportar">
                      <span class="material-icons">download</span>
                    </button>
                    <button class="btn-delete" (click)="confirmDelete(project.id, project.name, 'local'); $event.stopPropagation()" title="Excluir">
                      <span class="material-icons">delete</span>
                    </button>
                  </div>
                  <div class="project-badge local">
                    <span class="material-icons">computer</span>
                  </div>
                </div>
              }
            </div>
          }
        }
      }
    </div>
  </div>
</div>

<!-- Modal: Salvar Projeto -->
@if (showSaveDialog()) {
  <div class="dialog-overlay" (click)="showSaveDialog.set(false)">
    <div class="dialog" (click)="$event.stopPropagation()">
      <h3><span class="material-icons">save</span> Salvar Projeto</h3>
      
      <div class="form-group">
        <label>Nome do Projeto</label>
        <input 
          type="text" 
          [(ngModel)]="saveProjectName" 
          placeholder="Meu Projeto"
          class="form-input"
        >
      </div>
      
      <div class="form-group">
        <label>Onde salvar?</label>
        <div class="save-options">
          <label class="save-option" [class.disabled]="!supabase.isAuthenticated()">
            <input 
              type="radio" 
              name="saveLocation" 
              value="cloud" 
              [(ngModel)]="saveLocation"
              [disabled]="!supabase.isAuthenticated()"
            >
            <span class="material-icons">cloud</span>
            <div>
              <strong>Nuvem</strong>
              <span>Acesse de qualquer lugar</span>
            </div>
          </label>
          <label class="save-option">
            <input 
              type="radio" 
              name="saveLocation" 
              value="local" 
              [(ngModel)]="saveLocation"
            >
            <span class="material-icons">computer</span>
            <div>
              <strong>Local</strong>
              <span>Salvo neste navegador</span>
            </div>
          </label>
        </div>
        @if (!supabase.isAuthenticated()) {
          <p class="save-hint">
            <span class="material-icons">info</span>
            Faça login para salvar na nuvem
          </p>
        }
      </div>
      
      <div class="dialog-actions">
        <button class="btn-cancel" (click)="showSaveDialog.set(false)">Cancelar</button>
        <button class="btn-save" (click)="saveProject()" [disabled]="isSaving() || !saveProjectName.trim()">
          @if (isSaving()) {
            <span class="material-icons spin">sync</span> Salvando...
          } @else {
            <span class="material-icons">check</span> Salvar
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Modal: Confirmar Exclusão -->
@if (showDeleteConfirm()) {
  <div class="dialog-overlay" (click)="showDeleteConfirm.set(false)">
    <div class="dialog dialog-danger" (click)="$event.stopPropagation()">
      <h3><span class="material-icons">warning</span> Excluir Projeto</h3>
      <p>Tem certeza que deseja excluir <strong>"{{ projectToDelete?.name }}"</strong>?</p>
      <p class="danger-text">Esta ação não pode ser desfeita.</p>
      
      <div class="dialog-actions">
        <button class="btn-cancel" (click)="showDeleteConfirm.set(false)">Cancelar</button>
        <button class="btn-danger" (click)="deleteProject()">
          <span class="material-icons">delete</span> Excluir
        </button>
      </div>
    </div>
  </div>
}

<!-- Modal: Alterações não salvas -->
@if (showUnsavedChangesDialog()) {
  <div class="dialog-overlay">
    <div class="dialog" (click)="$event.stopPropagation()">
      <h3><span class="material-icons">warning</span> Alterações não salvas</h3>
      <p>Você tem alterações não salvas no projeto atual. O que deseja fazer?</p>
      
      <div class="dialog-actions three-buttons">
        <button class="btn-cancel" (click)="cancelPendingAction()">Cancelar</button>
        <button class="btn-discard" (click)="discardAndContinue()">Descartar</button>
        <button class="btn-save" (click)="saveAndContinue()">
          <span class="material-icons">save</span> Salvar
        </button>
      </div>
    </div>
  </div>
}

<!-- Modal: Autenticação -->
@if (showAuthDialog()) {
  <div class="dialog-overlay" (click)="showAuthDialog.set(false)">
    <div class="dialog auth-dialog" (click)="$event.stopPropagation()">
      <button class="dialog-close" (click)="showAuthDialog.set(false)">
        <span class="material-icons">close</span>
      </button>
      
      <h3>
        @if (authMode === 'login') {
          <span class="material-icons">login</span> Entrar
        } @else {
          <span class="material-icons">person_add</span> Criar Conta
        }
      </h3>
      
      <!-- Google Login -->
      <button class="google-login-btn full-width" (click)="signInWithGoogle()">
        <svg viewBox="0 0 24 24" width="18" height="18">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Continuar com Google
      </button>
      
      <div class="auth-divider">
        <span>ou</span>
      </div>
      
      <!-- Email Form -->
      <div class="form-group">
        <label>Email</label>
        <input 
          type="email" 
          [(ngModel)]="authEmail" 
          placeholder="seu@email.com"
          class="form-input"
        >
      </div>
      
      <div class="form-group">
        <label>Senha</label>
        <input 
          type="password" 
          [(ngModel)]="authPassword" 
          placeholder="••••••••"
          class="form-input"
          (keyup.enter)="submitAuth()"
        >
      </div>
      
      @if (authError()) {
        <div class="auth-error">
          <span class="material-icons">error</span>
          {{ authError() }}
        </div>
      }
      
      @if (authSuccess()) {
        <div class="auth-success">
          <span class="material-icons">check_circle</span>
          {{ authSuccess() }}
        </div>
      }
      
      <button class="btn-auth-submit" (click)="submitAuth()">
        @if (authMode === 'login') {
          Entrar
        } @else {
          Criar Conta
        }
      </button>
      
      <div class="auth-switch">
        @if (authMode === 'login') {
          Não tem conta? <button (click)="authMode = 'register'">Criar conta</button>
        } @else {
          Já tem conta? <button (click)="authMode = 'login'">Entrar</button>
        }
      </div>
    </div>
  </div>
}
